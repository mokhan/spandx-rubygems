#!/bin/bash

set -euo pipefail

echo "Adding hstore extension"
bin/console -q -c "CREATE EXTENSION IF NOT EXISTS hstore;"

echo "Droppping tables that we're going to load in"
bin/console -q -c "DROP TABLE IF EXISTS dependencies, gem_downloads, linksets, rubygems, versions CASCADE;"

base_url="https://s3-us-west-2.amazonaws.com/rubygems-dumps/"
prefix="production/public_postgresql"
key=$(curl -s "${base_url}?prefix=${prefix}" | sed -ne 's/.*<Key>\(.*\)<\/Key>.*/\1/p')
latest_url="${base_url}${key}"
echo "Downloading ${latest_url} to `public_postgresql.tar`"
curl --progress-bar "${latest_url}" > public_postgresql.tar

# Extract the single PostgresSQL.sql.gz file from the tar file, pass it through gunzip
# and load it as quietly as possible into the database
tar xOf "public_postgresql.tar" public_postgresql/databases/PostgreSQL.sql.gz | \
  gunzip -c | \
  bin/console

echo "Done."

#!/bin/bash

set -euo pipefail

echo "Adding hstore extension"
bin/sql -q -c "CREATE EXTENSION IF NOT EXISTS hstore;"

echo "Droppping tables that we're going to load in"
bin/sql -q -c "DROP TABLE IF EXISTS dependencies, gem_downloads, linksets, rubygems, versions CASCADE;"

latest_url="$1"
curl --progress-bar "${latest_url}" > tmp/public_postgresql.tar

# Extract the single PostgresSQL.sql.gz file from the tar file, pass it through gunzip
# and load it as quietly as possible into the database
tar xOf "tmp/public_postgresql.tar" public_postgresql/databases/PostgreSQL.sql.gz | \
  gunzip -c | \
  bin/sql

rm tmp/public_postgresql.tar
echo "Done."
